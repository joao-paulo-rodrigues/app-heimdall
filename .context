# Heimdall MDM ‚Äì PRD, Arquitetura e Guia de Execu√ß√£o (v0.6)

> **Contexto**: solu√ß√£o MDM (Android Device Owner) para gest√£o de dispositivos institucionais. Foco atual: funcionamento completo, logs informativos e rastre√°veis em toda a cadeia (device ‚Üí backend ‚Üí dashboard). Stack: **Android/Kotlin (API 28+)**, **MQTT (HiveMQ Client)**, **FastAPI**, **PostgreSQL**, **Redis**, **React + Tailwind**, **Docker**.

> **Status Atual (v0.6)**: Projeto Android compilando com sucesso. Sistema de comandos robusto implementado com ACK e reprocessamento. Sistema de comunica√ß√£o com PanicButton implementado. **Sistema de autoinstala√ß√£o e autoatualiza√ß√£o via URL implementado**. **Sistema de primeira execu√ß√£o com limpeza autom√°tica de apps implementado**. **Sistema de auditoria com t√≥pico MQTT dedicado implementado**. **Sistema de IMEI como device ID implementado** (gera√ß√£o determin√≠stica com valida√ß√£o Luhn). App completamente headless (sem interface, apenas toast). Tenant padr√£o: UEBRASIL. Room e Hilt preparados mas temporariamente desabilitados devido a incompatibilidade do kapt com Java 21. Para reativar: usar Java 11 ou migrar para KSP.

---

## 1) Objetivo Geral

Construir o **Heimdall**, um MDM (Mobile Device Management) que controla dispositivos Android da organiza√ß√£o, garantindo observabilidade completa. A aplica√ß√£o ser√° **headless** (sem interface no device), gerenciada por um **dashboard web** e capaz de controlar:

* Kiosk Mode para o app Companion (sensores).
* Instala√ß√£o e atualiza√ß√£o remota de apps.
* Pol√≠ticas de interrup√ß√£o e bloqueio de notifica√ß√µes.
* Telemetria e logs centralizados.
* Reconex√£o MQTT autom√°tica, com armazenamento local em caso de falha.

Todos os logs devem ser **sem emojis**, com informa√ß√µes claras, rastre√°veis e formatadas para an√°lise em pipelines ELK/Grafana.

---

## 2) Requisitos de Logging

### 2.1 Princ√≠pios de Log

* Nenhum emoji, s√≠mbolo decorativo ou cores ANSI.
* Formato JSON estruturado (key/value).
* Cada evento deve incluir: `timestamp`, `component`, `level`, `device_id`, `tenant_id`, `trace_id` e `message`.
* N√≠veis: `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`.
* Logs devem ser **line-based**, um JSON por linha.

### 2.2 Estrutura do Log

```json
{
  "timestamp": "2025-11-09T22:00:00Z",
  "component": "heimdall.device.mqtt",
  "level": "INFO",
  "device_id": "A1B2C3",
  "tenant_id": "ORG001",
  "trace_id": "CMD-5f9...",
  "message": "Received command install_app",
  "metadata": {
    "topic": "v1/heimdall/tenants/ORG001/devices/A1B2C3/cmd",
    "qos": 1
  }
}
```

### 2.3 Logs no Device (Heimdall)

* **Servi√ßo MQTT**: logs para cada evento de conex√£o, reconex√£o, ping/pong, envio e recebimento.
* **Store-and-Forward**: logs ao enfileirar ou reenviar pacotes.
* **Kiosk Controller**: logs de entrada e sa√≠da do modo kiosk.
* **PackageInstaller**: logs por instala√ß√£o iniciada, conclu√≠da e com erro.
* **Boot e Watchdog**: logs de inicializa√ß√£o, restart de servi√ßos e falhas detectadas.

### 2.4 Logs no Backend

* Logs HTTP: m√©todo, rota, status, tempo de resposta, `trace_id`.
* Logs MQTT Bridge: publica√ß√£o e consumo de mensagens, ack e falhas.
* Logs WebSocket: abertura, fechamento e eventos enviados ao frontend.
* Logs DB/Redis: conex√µes, retries e erros de persist√™ncia.

### 2.5 Logs no Frontend (Admin Web)

* Sem emoji ou decora√ß√£o.
* Console e DevTools devem exibir: requisi√ß√µes WebSocket, status de conex√£o, eventos recebidos e comandos enviados.

---

## 3) Persist√™ncia e Observabilidade

* Todos os logs do backend devem ser armazen√°veis em **stdout** (para coleta por Docker ou Loki).
* O backend poder√° enviar logs cr√≠ticos para um canal MQTT (`v1/heimdall/logs/critical`) para alertas remotos.
* Cada comando (`cmd_id`) ter√° rastreamento de ponta a ponta: backend ‚Üí MQTT ‚Üí device ‚Üí ack.

---

## 4) Integra√ß√£o com o Dashboard

* O dashboard deve exibir logs em tempo real via **WebSocket** com filtros (`device_id`, `tenant`, `component`, `level`).
* Logs antigos poder√£o ser consultados via `/api/v1/logs?device_id=...&level=INFO&since=...`.
* Colunas principais na UI: `timestamp`, `component`, `level`, `message`, `trace_id`.

---

## 5) Componentes Principais

* **Heimdall (Android)**: publica logs locais (arquivo) e via MQTT (`telemetry/logs`).
* **Backend (FastAPI)**: consolida logs, processa e repassa eventos para o dashboard.
* **Dashboard (React)**: exibe logs com filtros, sem √≠cones ou formata√ß√£o colorida.

---

## 6) Padr√£o de Log Unificado

| Campo     | Tipo   | Descri√ß√£o                                 |
| --------- | ------ | ----------------------------------------- |
| timestamp | string | Data/hora UTC do evento                   |
| level     | string | DEBUG / INFO / WARNING / ERROR / CRITICAL |
| component | string | Nome do m√≥dulo ou classe                  |
| device_id | string | ID do dispositivo (se aplic√°vel)          |
| tenant_id | string | ID do tenant (se aplic√°vel)               |
| trace_id  | string | ID √∫nico do evento ou comando relacionado |
| message   | string | Texto explicativo do evento               |
| metadata  | object | Dados adicionais contextuais              |

---

## 7) Estrutura do Projeto Android

### 7.1 Organiza√ß√£o de Pacotes

```
com.heimdall.device/
‚îú‚îÄ‚îÄ config/              # Configura√ß√µes (MQTT, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ MqttConfig.kt
‚îú‚îÄ‚îÄ command/             # Sistema de comandos robusto
‚îÇ   ‚îú‚îÄ‚îÄ Command.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandResult.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandAck.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandHandler.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandAckManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandRetryManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ StoreAndForwardManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ CommandProcessors.kt
‚îÇ   ‚îî‚îÄ‚îÄ PanicButtonCommandHandlers.kt
‚îú‚îÄ‚îÄ panicbutton/         # Comunica√ß√£o com PanicButton
‚îÇ   ‚îú‚îÄ‚îÄ PanicButtonCommunicationManager.kt
‚îÇ   ‚îî‚îÄ‚îÄ PanicButtonEventReceiver.kt
‚îú‚îÄ‚îÄ update/              # Sistema de atualiza√ß√£o e instala√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ UpdateConfig.kt
‚îÇ   ‚îú‚îÄ‚îÄ UpdateManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ DownloadManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ InstallManager.kt
‚îÇ   ‚îú‚îÄ‚îÄ UpdateResult.kt
‚îÇ   ‚îú‚îÄ‚îÄ InstallResultReceiver.kt
‚îÇ   ‚îî‚îÄ‚îÄ UninstallResultReceiver.kt
‚îú‚îÄ‚îÄ init/                # Sistema de primeira execu√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ FirstRunManager.kt
‚îú‚îÄ‚îÄ cleanup/             # Limpeza de apps n√£o essenciais
‚îÇ   ‚îî‚îÄ‚îÄ AppCleanupManager.kt
‚îú‚îÄ‚îÄ audit/               # Sistema de auditoria
‚îÇ   ‚îî‚îÄ‚îÄ AuditManager.kt
‚îú‚îÄ‚îÄ database/            # Room Database (temporariamente desabilitado)
‚îÇ   ‚îú‚îÄ‚îÄ HeimdallDatabase.kt.bak
‚îÇ   ‚îú‚îÄ‚îÄ LogEntry.kt.bak
‚îÇ   ‚îú‚îÄ‚îÄ LogDao.kt.bak
‚îÇ   ‚îú‚îÄ‚îÄ PendingMessage.kt.bak
‚îÇ   ‚îî‚îÄ‚îÄ PendingMessageDao.kt.bak
‚îú‚îÄ‚îÄ receiver/            # BroadcastReceivers
‚îÇ   ‚îú‚îÄ‚îÄ BootReceiver.kt
‚îÇ   ‚îî‚îÄ‚îÄ HeimdallDeviceAdminReceiver.kt
‚îú‚îÄ‚îÄ service/             # Servi√ßos
‚îÇ   ‚îî‚îÄ‚îÄ MqttServiceManager.kt
‚îú‚îÄ‚îÄ util/                # Utilit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ Logger.kt
‚îÇ   ‚îî‚îÄ‚îÄ ImeiUtils.kt     # Gerador de IMEI (15 d√≠gitos, Luhn-v√°lido)
‚îú‚îÄ‚îÄ HeimdallApplication.kt
‚îî‚îÄ‚îÄ MainActivity.kt      # Headless (sem UI, apenas toast)
```

### 7.2 Stack Tecnol√≥gica Implementada

**Kotlin**: 1.9.20
- Vers√£o: 1.9.20 (definida em `gradle/libs.versions.toml`)
- JVM Target: 11
- Compiler: Kotlin/JVM
- Language Features: Coroutines, Extension Functions, Data Classes, Sealed Classes
- **kapt**: Desabilitado temporariamente (incompatibilidade com Java 21)
- **KSP**: Op√ß√£o futura para substituir kapt (mais moderno e compat√≠vel)

**MQTT Client**: HiveMQ Client 1.3.0 (substituindo Paho)
- Biblioteca: `com.hivemq:hivemq-mqtt-client:1.3.0`
- API: MQTT 5.0 com `Mqtt5AsyncClient`
- M√©todos: `publishWith()`, `subscribeWith()`, `connect()`

**JSON**: org.json (substituindo Gson)
- Biblioteca: `org.json:json:20231013`
- Uso: `JSONObject` para logs estruturados
- Motivo: Mais leve que Gson, sem depend√™ncias adicionais

**Security Crypto**: androidx.security:security-crypto:1.1.0-alpha06
- Biblioteca: `androidx.security:security-crypto:1.1.0-alpha06`
- Uso: `EncryptedSharedPreferences` para armazenamento seguro do IMEI
- Persist√™ncia criptografada de dados sens√≠veis

**Coroutines**: Kotlin Coroutines 1.7.1
- `kotlinx-coroutines-core:1.7.1`
- `kotlinx-coroutines-android:1.7.1`
- Uso: Opera√ß√µes ass√≠ncronas, MQTT, processamento de comandos
- Dispatchers: IO para opera√ß√µes de rede/arquivo, Main para UI (quando necess√°rio)

**WorkManager**: 2.8.1
- Para tarefas em background e sincroniza√ß√£o
- Work peri√≥dico para compliance e monitoramento

**Version Catalog**: Implementado
- Arquivo: `gradle/libs.versions.toml`
- Centraliza vers√µes de depend√™ncias
- Facilita gerenciamento e atualiza√ß√£o de vers√µes

### 7.3 Configura√ß√£o MQTT

**Servidor**: 177.87.122.5:1883
**Usu√°rio**: mosquitto_broker_user_ue
**Senha**: tiue@Mosquitto2025#

**T√≥picos**:
- Comandos: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/cmd`
- Status: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/status`
- ACK: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/ack`
- Logs: `v1/heimdall/telemetry/logs`
- Panic: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/panic`
- Telemetria: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/telemetry`
- **Auditoria**: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/audit`

**Tenant Padr√£o**: UEBRASIL

### 7.4 Status de Implementa√ß√£o

**‚úÖ Implementado e Funcionando**:
- Estrutura base do projeto Android
- Gradle Wrapper configurado
- MQTT Service Manager com HiveMQ
- Logger estruturado (JSON) com org.json
- Device Admin Receiver configurado
- Boot Receiver para inicializa√ß√£o autom√°tica
- Script de build e instala√ß√£o (`run.sh`)
- Configura√ß√£o de Device Owner no script
- Wipe data autom√°tico no script
- **Sistema de comandos robusto** com ACK em 3 est√°gios (RECEIVED, PROCESSING, RESULT)
- **Reprocessamento autom√°tico** com backoff exponencial (at√© 3 tentativas)
- **Store-and-Forward** para mensagens pendentes quando MQTT offline
- **Idempot√™ncia** de comandos (comandos duplicados ignorados)
- **Sistema de comunica√ß√£o com PanicButton** (BroadcastReceiver, SharedPreferences, Intents)
- **Handlers de comandos do PanicButton** (kiosk mode, sync, status, comandos customizados)
- **EventReceiver para eventos do PanicButton** (panic triggered, status update, sensor data)
- **Sistema de autoinstala√ß√£o e autoatualiza√ß√£o via URL** (download de qualquer URL, instala√ß√£o silenciosa)
- **Handlers de comandos de atualiza√ß√£o** (install_app, update_app, uninstall_app, check_updates)
- **Sistema de primeira execu√ß√£o** (detec√ß√£o autom√°tica, limpeza de apps n√£o essenciais)
- **Sistema de auditoria** (t√≥pico MQTT dedicado para eventos de auditoria)
- **Sistema de IMEI como device ID** (gera√ß√£o determin√≠stica, valida√ß√£o Luhn, persist√™ncia criptografada)
- **App headless** (sem interface, apenas toast informativo)
- **Tenant padr√£o**: UEBRASIL

**‚ö†Ô∏è Temporariamente Desabilitado**:
- Room Database (devido a incompatibilidade kapt com Java 21)
- Hilt Dependency Injection (requer kapt)
- Arquivos Room movidos para `.bak` (podem ser restaurados)

**üìã Para Reativar Room/Hilt**:
1. Op√ß√£o 1: Usar Java 11 (recomendado)
   - Configurar `JAVA_HOME` para Java 11
   - Reativar plugin `kotlin-kapt` no `build.gradle.kts`
   - Descomentar depend√™ncias Room e Hilt
   - Restaurar arquivos `.bak` do database

2. Op√ß√£o 2: Migrar para KSP (Kotlin Symbol Processing)
   - Substituir `kapt` por `ksp` no `build.gradle.kts`
   - Atualizar depend√™ncias para usar `ksp()` ao inv√©s de `kapt()`

### 7.5 Build e Execu√ß√£o

**Scripts Dispon√≠veis**:
- `android/run.sh`: Script completo que:
  1. Verifica/inicia emulador
  2. Faz wipe data do emulador
  3. Compila o projeto
  4. Instala no emulador
  5. Configura Device Owner
  6. Inicia o app

**Requisitos**:
- Android SDK (API 28+)
- Gradle 8.2+
- Java 11+ (recomendado Java 11 para kapt)
- ADB configurado no PATH

**Compila√ß√£o Manual**:
```bash
cd android
./gradlew clean assembleDebug
./gradlew installDebug
```

### 7.6 Logger Implementado

**Localiza√ß√£o**: `com.heimdall.device.util.Logger`

**Caracter√≠sticas**:
- Formato JSON estruturado (sem emojis)
- Armazenamento local em arquivo (`/data/data/com.heimdall.device/files/heimdall_logs/heimdall.log`)
- Publica√ß√£o via MQTT (quando conectado)
- N√≠veis: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Campos: timestamp, level, component, device_id, tenant_id, trace_id, message, metadata
- Usa `org.json.JSONObject` para serializa√ß√£o
- Timestamp em formato ISO 8601 UTC

**Uso**:
```kotlin
Logger.info(
    component = "heimdall.device.mqtt",
    message = "Connection established",
    metadata = mapOf("server" to "177.87.122.5")
)
```

**Device ID**: O Logger usa IMEI (gerado ou real) como device ID. O IMEI √© gerado/obtido na inicializa√ß√£o via `ImeiUtils.getOrGenerateImei()`.

### 7.7 IMEI como Device ID

**Localiza√ß√£o**: `com.heimdall.device.util.ImeiUtils`

**Caracter√≠sticas**:
- Gera IMEI de 15 d√≠gitos v√°lido (algoritmo Luhn)
- Tenta obter IMEI real do TelephonyManager
- Se n√£o dispon√≠vel, gera IMEI sint√©tico baseado no ANDROID_ID
- Prefixo "86" para IMEIs sint√©ticos
- Persist√™ncia criptografada usando EncryptedSharedPreferences
- Valida√ß√£o Luhn autom√°tica

**Integra√ß√£o**:
- Logger usa IMEI como device ID na inicializa√ß√£o
- Todo o sistema usa `Logger.getDeviceId()` que retorna o IMEI
- MQTT topics, logs, auditoria, comandos - tudo usa IMEI

### 7.8 AndroidManifest e Permiss√µes

**Permiss√µes Configuradas**:
- `INTERNET`: Conex√£o MQTT
- `ACCESS_NETWORK_STATE`: Verificar conectividade
- `WAKE_LOCK`: Manter conex√£o ativa
- `RECEIVE_BOOT_COMPLETED`: Iniciar ap√≥s boot
- `BIND_DEVICE_ADMIN`: Device Owner
- `INSTALL_PACKAGES`: Instala√ß√£o remota (requer Device Owner)
- `DELETE_PACKAGES`: Remo√ß√£o remota (requer Device Owner)
- `QUERY_ALL_PACKAGES`: Listar apps instalados
- `WRITE_EXTERNAL_STORAGE` / `READ_EXTERNAL_STORAGE`: Armazenamento

**Componentes Registrados**:
- `HeimdallApplication`: Application class (preparado para Hilt, mas desabilitado)
- `MainActivity`: Activity principal (headless, sem UI, apenas toast, fecha imediatamente)
- `BootReceiver`: Inicializa√ß√£o autom√°tica ap√≥s boot (conecta MQTT)
- `HeimdallDeviceAdminReceiver`: Device Admin/Owner (pol√≠ticas MDM)
- `PanicButtonEventReceiver`: Recebe eventos do PanicButton (panic, status, sensores)
- Network Security Config: Permite cleartext traffic para MQTT n√£o-SSL
- Queries para visibilidade do PanicButton (Android 11+)

**Nota**: HiveMQ Client n√£o requer Service registrado no manifest (diferente do Paho)

### 7.9 Scripts e Automa√ß√£o

**`android/run.sh`**:
- Detecta/inicia emulador automaticamente
- Faz wipe data antes da instala√ß√£o
- Compila e instala o APK
- Configura Device Owner automaticamente
- Verifica status do Device Owner
- Inicia o app automaticamente

**Uso**:
```bash
cd android
./run.sh                    # Usa primeiro AVD dispon√≠vel
./run.sh Pixel_5_API_33     # Especifica AVD
```

---

## 8) Sistema de Comandos Robusto

### 8.1 Arquitetura

Sistema completo de comandos com ACK robusto, reprocessamento autom√°tico e store-and-forward:

- **CommandHandler**: Coordenador principal de processamento
- **CommandAckManager**: Gerencia envio de ACKs (RECEIVED, PROCESSING, RESULT)
- **CommandRetryManager**: Reprocessamento autom√°tico com backoff exponencial
- **StoreAndForwardManager**: Armazena mensagens quando MQTT offline (at√© 1000 itens)

### 8.2 Fluxo de Processamento

1. Comando recebido via MQTT
2. ACK RECEIVED enviado imediatamente
3. Verifica√ß√£o de idempot√™ncia
4. ACK PROCESSING enviado
5. Processador executado
6. Resultado enviado (ACK final)
7. Se falhar: retry autom√°tico (at√© 3 tentativas)
8. Se MQTT offline: armazenado para envio posterior

### 8.3 Comandos Implementados

**B√°sicos**:
- `ping`: Comando de teste
- `get_device_status`: Status do dispositivo

**PanicButton**:
- `configure_panicbutton_kiosk`: Configura modo kiosk
- `sync_panicbutton_data`: Sincroniza dados compartilhados
- `get_panicbutton_status`: Obt√©m status do PanicButton
- `send_panicbutton_command`: Envia comando customizado

**Instala√ß√£o/Atualiza√ß√£o**:
- `install_app`: Baixa e instala APK de uma URL
- `update_app`: Alias para install_app
- `uninstall_app`: Desinstala um app
- `check_updates`: Verifica vers√£o instalada de um app

### 8.4 Documenta√ß√£o

Ver `docs/COMMAND_SYSTEM.md` para documenta√ß√£o completa do sistema de comandos.

## 9) Sistema de Comunica√ß√£o com PanicButton

### 9.1 Arquitetura

Sistema robusto de comunica√ß√£o entre Heimdall e PanicButton usando m√∫ltiplos m√©todos:

- **BroadcastReceiver**: Eventos em tempo real (panic triggered, status update, sensor data)
- **SharedPreferences**: Dados compartilhados (IMEI, Device ID, Tenant ID, MQTT config)
- **Intents**: Comandos diretos ao PanicButton
- **Event Listeners**: Sistema de callbacks para eventos

### 9.2 Dados Compartilhados

- Device ID / IMEI
- Tenant ID (UEBRASIL)
- Configura√ß√£o MQTT (host, port, username, tenant_id)
- Status de kiosk mode
- Timestamp da √∫ltima atualiza√ß√£o

### 9.3 Eventos Recebidos

- `PANIC_TRIGGERED`: Evento de p√¢nico (publicado via MQTT em t√≥pico `/panic`)
- `STATUS_UPDATE`: Atualiza√ß√µes de status do PanicButton
- `SENSOR_DATA`: Dados de sensores (publicados como telemetria)

### 9.4 Comandos Enviados

- Configura√ß√£o de kiosk mode
- Sincroniza√ß√£o de dados
- Comandos customizados via Intent

## 10) A√ß√µes Recomendadas

1. ‚úÖ **LoggerService implementado** em Kotlin com append local + envio MQTT
2. ‚úÖ **Sistema de comandos robusto** com ACK e reprocessamento
3. ‚úÖ **Sistema de comunica√ß√£o com PanicButton** implementado
4. ‚úÖ **Sistema de autoinstala√ß√£o e autoatualiza√ß√£o via URL** implementado
5. ‚úÖ **Sistema de primeira execu√ß√£o com limpeza autom√°tica** implementado
6. ‚úÖ **Sistema de auditoria com t√≥pico MQTT dedicado** implementado
7. ‚úÖ **Sistema de IMEI como device ID** implementado (gera√ß√£o determin√≠stica, Luhn-v√°lido)
8. ‚úÖ **App headless** configurado
9. ‚ö†Ô∏è **Room Database**: Reativar quando usar Java 11 ou migrar para KSP
10. ‚ö†Ô∏è **Hilt DI**: Reativar junto com Room
11. üìã Implementar **interceptor global** no FastAPI para logs estruturados
12. üìã Configurar dashboard com viewer de logs (filtros + busca)
13. üìã Integrar Loki ou outro coletor no `docker-compose` para an√°lise centralizada
14. üìã Implementar handlers de comandos MDM adicionais (kiosk_mode, etc.)
15. üìã Implementar dashboard de auditoria para visualizar eventos

---

## 11) Notas T√©cnicas

### 11.1 Kotlin e kapt - Incompatibilidade com Java 21

**Vers√£o Kotlin**: 1.9.20
- Configurado em `gradle/libs.versions.toml`
- JVM Target: 11 (compat√≠vel com Android API 28+)
- Compiler: Kotlin/JVM padr√£o

**kapt (Kotlin Annotation Processing Tool)**:
- Status: Desabilitado temporariamente
- Motivo: Incompatibilidade com Java 21 devido a restri√ß√µes de m√≥dulos do Java
- Impacto: Room Database e Hilt DI n√£o podem ser usados atualmente
- Tentativas: Flags `--add-opens` e `--add-exports` no `gradle.properties` n√£o resolvem completamente

**Solu√ß√µes**:
1. **Usar Java 11** (recomendado para compatibilidade imediata)
   - Configurar `JAVA_HOME` para Java 11
   - Reativar plugin `kotlin-kapt` no `build.gradle.kts`
   - Descomentar depend√™ncias Room e Hilt
   - Restaurar arquivos `.bak` do database

2. **Migrar para KSP** (Kotlin Symbol Processing) - Recomendado para futuro
   - Substituir `kapt` por `ksp` no `build.gradle.kts`
   - Atualizar depend√™ncias para usar `ksp()` ao inv√©s de `kapt()`
   - KSP √© mais r√°pido e compat√≠vel com Java 21
   - N√£o requer flags especiais no `gradle.properties`

**Nota**: O projeto compila e funciona perfeitamente sem kapt. Room e Hilt s√£o opcionais e podem ser reativados quando necess√°rio.

### 11.2 Estrutura Baseada em Projeto Existente

O projeto foi estruturado seguindo o padr√£o do projeto existente em `/Users/joaopaulo/AndroidStudioProjects/heimdall/app`, incluindo:
- Version catalog para gerenciamento de depend√™ncias
- HiveMQ Client ao inv√©s de Paho
- org.json ao inv√©s de Gson
- Estrutura de pacotes similar
- Configura√ß√µes de build alinhadas

### 11.3 Device Owner

O script `run.sh` configura automaticamente o app como Device Owner ap√≥s instala√ß√£o, permitindo:
- Instala√ß√£o/remo√ß√£o de apps
- Controle de pol√≠ticas do dispositivo
- Kiosk mode
- Outras funcionalidades MDM

---

### 11.4 App Headless

O Heimdall √© completamente headless (sem interface visual):
- MainActivity n√£o define layout (`setContentView()` n√£o √© chamado)
- Tema transparente configurado
- Toast informativo: "Heimdall MDM est√° rodando"
- Activity fecha imediatamente ap√≥s inicializar servi√ßos
- App continua rodando em background
- Configurado no manifest: `excludeFromRecents`, `finishOnTaskLaunch`, `noHistory`

### 11.5 Sistema de Comandos

- **ACK em 3 est√°gios**: RECEIVED ‚Üí PROCESSING ‚Üí RESULT
- **Reprocessamento**: At√© 3 tentativas com backoff exponencial (5s, 10s, 20s)
- **Store-and-Forward**: Armazena at√© 1000 mensagens quando offline
- **Idempot√™ncia**: Comandos duplicados s√£o ignorados automaticamente
- **Rastreamento**: Todos os comandos t√™m `command_id` e `trace_id` para rastreamento end-to-end

### 11.6 Comunica√ß√£o com PanicButton

- **M√∫ltiplos m√©todos**: BroadcastReceiver, SharedPreferences, Intents
- **Eventos em tempo real**: Panic triggered, status updates, sensor data
- **Publica√ß√£o MQTT**: Eventos cr√≠ticos publicados automaticamente
- **Sincroniza√ß√£o**: Dados compartilhados sincronizados automaticamente
- **Resili√™ncia**: Funciona mesmo se PanicButton n√£o estiver instalado

### 11.7 Sistema de Autoinstala√ß√£o e Autoatualiza√ß√£o

- **Download Simples**: Baixa APK de qualquer URL HTTP/HTTPS
- **Download Robusto**: Retry autom√°tico, progress tracking
- **Instala√ß√£o Silenciosa**: Usa Device Owner com `USER_ACTION_NOT_REQUIRED` para instala√ß√£o sem intera√ß√£o
- **Comandos MQTT**: `install_app` (com URL), `update_app`, `uninstall_app`, `check_updates`
- **Logs Estruturados**: Todos os eventos registrados com detalhes completos
- **Limpeza Autom√°tica**: Remove arquivos tempor√°rios antigos automaticamente

**Par√¢metros de install_app**:
- `url` (obrigat√≥rio): URL do APK para download
- `package_name` (opcional): Nome do pacote esperado
- `force` (opcional): For√ßa reinstala√ß√£o

**Documenta√ß√£o**: Ver `docs/UPDATE_SYSTEM.md` para detalhes completos

### 11.8 Sistema de Primeira Execu√ß√£o e Limpeza

- **Detec√ß√£o Autom√°tica**: Verifica se √© primeira execu√ß√£o via SharedPreferences
- **Limpeza Inteligente**: Remove apps n√£o essenciais automaticamente
- **Apps Protegidos**: Mant√©m apps do sistema, Google Play Services, Heimdall e PanicButton
- **Eventos de Auditoria**: Publica eventos no t√≥pico de auditoria para cada a√ß√£o
- **Execu√ß√£o Ass√≠ncrona**: N√£o bloqueia inicializa√ß√£o do app

**Fluxo**:
1. Heimdall detecta primeira execu√ß√£o
2. Publica evento `first_run_started`
3. Identifica apps n√£o essenciais
4. Remove apps um por um
5. Publica eventos de auditoria para cada remo√ß√£o
6. Publica evento `first_run_completed` com resumo

### 11.9 Sistema de Auditoria

- **T√≥pico Dedicado**: `v1/heimdall/tenants/{tenant_id}/devices/{device_id}/audit`
- **Eventos Publicados**: first_run_started, cleanup_started, app_removed, cleanup_completed, etc.
- **Formato JSON**: Estruturado com timestamp, event_type, message, metadata
- **Integra√ß√£o Completa**: Todos os eventos importantes s√£o publicados

**Eventos de Auditoria**:
- `first_run_started`: Primeira execu√ß√£o iniciada
- `cleanup_started`: Limpeza de apps iniciada
- `app_removed`: App removido com sucesso
- `app_removal_failed`: Falha ao remover app
- `cleanup_completed`: Limpeza completada
- `first_run_completed`: Primeira execu√ß√£o completada
- `first_run_failed`: Primeira execu√ß√£o falhou

### 11.10 Sistema de IMEI como Device ID

- **Gera√ß√£o Determin√≠stica**: IMEI de 15 d√≠gitos baseado no ANDROID_ID
- **Valida√ß√£o Luhn**: IMEI sempre v√°lido pelo algoritmo Luhn
- **Dual-Source**: Tenta IMEI real, sen√£o gera sint√©tico
- **Persist√™ncia Criptografada**: Armazenado em EncryptedSharedPreferences
- **Uso Universal**: IMEI usado como device ID em todo o sistema

**Caracter√≠sticas**:
- 15 d√≠gitos num√©ricos
- Prefixo "86" para IMEIs sint√©ticos
- Algoritmo Luhn v√°lido
- Persistente (mesmo IMEI ap√≥s reinicializa√ß√µes)
- Criptografado (armazenamento seguro)

**Integra√ß√£o**:
- Logger usa IMEI como device ID
- MQTT topics usam IMEI
- Logs estruturados usam IMEI
- Auditoria usa IMEI
- PanicButton recebe IMEI compartilhado

### 11.11 Padr√µes Kotlin Utilizados

**Coroutines e Concorr√™ncia**:
- `CoroutineScope` com `SupervisorJob` para opera√ß√µes independentes
- `Dispatchers.IO` para opera√ß√µes de rede e arquivo
- `Dispatchers.Main` para opera√ß√µes de UI (quando necess√°rio)
- `launch` para opera√ß√µes ass√≠ncronas sem retorno
- `async/await` para opera√ß√µes com retorno
- `delay()` para delays n√£o-bloqueantes

**Singleton Pattern**:
- `object` para singletons (Logger)
- `companion object` com `@Volatile` e `synchronized` para lazy initialization thread-safe
- Exemplos: `MqttServiceManager`, `StoreAndForwardManager`, `PanicButtonCommunicationManager`

**Data Classes**:
- `Command`, `CommandResult`, `CommandAck` como data classes
- Serializa√ß√£o/deserializa√ß√£o JSON manual (sem Gson)

**Extension Functions**:
- Fun√ß√µes de extens√£o para facilitar uso de APIs Android
- Helpers para convers√£o de tipos

**Sealed Classes** (quando aplic√°vel):
- `CommandResult.CommandStatus` como enum
- `CommandAck.AckType` como enum

**Null Safety**:
- Uso extensivo de safe calls (`?.`)
- Elvis operator (`?:`) para valores padr√£o
- `let`, `apply`, `run` para escopo seguro

**Functional Programming**:
- `map`, `filter`, `forEach` para cole√ß√µes
- Higher-order functions para callbacks
- Lambda expressions para c√≥digo conciso

## 12) Conclus√£o

O sistema Heimdall est√° estruturado e compilando com sucesso. Sistema de comandos robusto implementado com ACK e reprocessamento. Sistema de comunica√ß√£o com PanicButton implementado. Sistema de autoinstala√ß√£o e autoatualiza√ß√£o via URL implementado. Sistema de primeira execu√ß√£o com limpeza autom√°tica de apps implementado. Sistema de auditoria com t√≥pico MQTT dedicado implementado. Sistema de IMEI como device ID implementado (gera√ß√£o determin√≠stica com valida√ß√£o Luhn, persist√™ncia criptografada). App completamente headless. A base est√° pronta para desenvolvimento das funcionalidades MDM. Todos os componentes seguem o padr√£o de log unificado, garantindo que **nenhum evento ocorra sem registro detalhado**, e todos os logs sejam **informativos, leg√≠veis e sem emojis**.

**Pr√≥ximos Passos**:
1. Testar sistema de primeira execu√ß√£o e limpeza no emulador usando `./run.sh`
2. Testar sistema de atualiza√ß√£o com URL real de APK
3. Verificar eventos de auditoria no t√≥pico MQTT
4. Reativar Room/Hilt quando poss√≠vel (Java 11 ou KSP)
5. Implementar handlers de comandos MDM adicionais (kiosk_mode, etc.)
6. Desenvolver funcionalidades MDM completas (pol√≠ticas, etc.)
7. Desenvolver dashboard de auditoria para visualizar eventos
8. Desenvolver PanicButton app para integra√ß√£o completa
